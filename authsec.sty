\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{authsec}[2023/05/01 KOMA Report Customizations]
% For debugging
%\errorcontextlines=1000
%% For debugging layout
%\ifluatex%
%\RequirePackage{lua-visual-debug}%
%\fi%
%\RequirePackage{showframe}

\RequirePackage{graphicx}
\RequirePackage{longtable}
\RequirePackage{wrapfig}
\RequirePackage{rotating}
\RequirePackage[normalem]{ulem}
\RequirePackage{amsmath}
\RequirePackage{amssymb}
\RequirePackage{capt-of}
\RequirePackage{minted}
\RequirePackage{titling}
\RequirePackage[section]{placeins} %set all floating objects before a new section starts
\RequirePackage{needspace} % ensure a certain amount of space on a page (used for starting a section only if at least 1/3 of the page is available)
\RequirePackage{iftex,ifxetex,ifluatex}
%% Provide \ifxetexorluatex
\newif\ifxetexorluatex%
\ifxetex%
  \xetexorluatextrue%
\else%
  \ifluatex%
    \xetexorluatextrue%
  \else%
    \xetexorluatexfalse%
  \fi%
\fi%

%% Handle Options %%
\RequirePackage{kvoptions,etoolbox}
\SetupKeyvalOptions{
  family=authsec,%
  prefix=authsec@,%
  setkeys=\kvsetkeys%
}
\DeclareStringOption{titlepagedictumtext}
\DeclareStringOption{titlepagedictumauthor}
\DeclareStringOption[american]{language}
\DeclareStringOption[]{languageoptions}
\DeclareStringOption[ieee]{bibstyle}
\DeclareStringOption[Version: \today]{draftcontents}
\DeclareBoolOption{marginsections}
\DeclareBoolOption{draft}
\DeclareBoolOption{buildglosses}

%\DeclareLocalOptions{titledictum}
\ProcessKeyvalOptions*%

%%\RequirePackage{pagecolor}
%%\pagecolor{yellow!30!orange}

\makeatletter
\unless\ifauthsec@draft%
  \RequirePackage{microtype}
\fi% 
\makeatother

\RequirePackage{setspace} % for line spacing, e.g. \onehalfspacing
\RequirePackage{scrlayer-scrpage}
\RequirePackage{scrhack}
\RequirePackage{csquotes}
\RequirePackage{pdflscape}

% Select/setup fonts
\ifxetexorluatex%
  \RequirePackage{fontspec}
  %\message{[EmRE] loaded language: '\authsec@language' with options '\authsec@languageoptions'.}
  \RequirePackage[babelshorthands]{polyglossia}
  \makeatletter
  \setdefaultlanguage[\authsec@languageoptions]{\authsec@language}
  \makeatother
\else%
  \RequirePackage[sc]{mathpazo}% Palatino with smallcaps
  \RequirePackage[scaled]{helvet}% Helvetica, scaled 95%
  \RequirePackage{eulervm}% Euler math
  \RequirePackage[T1]{fontenc}
  \makeatletter
  \RequirePackage[\authsec@languageoptions,\authsec@language]{babel}
  \makeatother
\fi%

\makeatletter
\RequirePackage[backend=biber,style=\authsec@bibstyle]{biblatex}
\makeatother

\RequirePackage[style=iso]{datetime2}
\RequirePackage{menukeys}
\RequirePackage{tikz}
\RequirePackage{awesomebox}
\RequirePackage{calc}

% Change Verbatim environment
\RequirePackage{fvextra}% loads fancyvrb
\DefineVerbatimEnvironment{verbatim}{Verbatim}{breaklines,breakafter={\space, \,, \#, \[, \], \{, \}, \%, /, -, _},fontsize=\normalsize,formatcom={\color[rgb]{0.5,0.5,0}}}

\makeatletter
\ifauthsec@draft%
   \RequirePackage{tikzpagenodes}
   \RequirePackage[
    contents={},
    opacity=1,
    scale=1.5,
    color=colorchapternumber!25
    ]{background}
    \AddEverypageHook{%
    \Ifthispageodd{%
      \backgroundsetup{
      angle=270,
      position={.715\textwidth,-0.64\textheight},
      contents={\authsec@draftcontents}
      }%
      }{%
      \backgroundsetup{
      angle=90,
      position={-1,-0.64\textheight},
      contents={\authsec@draftcontents}
      }
      }%
      \BgMaterial}
\fi
\makeatother

\RequirePackage{hyperref}
\RequirePackage[splitindex]{imakeidx}

\makeatletter
\ifauthsec@buildglosses%
%% Load glossaries after hyperref, babel, polyglossia,inputenc,fontenc
\RequirePackage[toc,acronyms,numberedsection]{glossaries}
\fi
\makeatother

%% Add chapter and section as page headers
\automark[chapter]{chapter}
\automark*[section]{}

% **************************************************
% Page construction
% **************************************************
\KOMAoption{headinclude}{false}     % include header in body?
\KOMAoption{footinclude}{false}      % include footer in body?
\KOMAoption{footlines}{2.1}         % number of foot lines
\KOMAoption{mpinclude}{false}       % include marginpar in body?
%% \KOMAoption{BCOR}{25mm}             % binding correction
\KOMAoption{DIV}{12}                % number of page divs (divider)
\KOMAoption{titlepage}{firstiscover}
\KOMAoption{abstract}{true}
\KOMAoption{toc}{indexnumbered}     % Assign a number (or letter in appendix) to the index.
\KOMAoptions{%
    listof=totocnumbered,%
    bibliography=totoc%
}
\KOMAoption{chapterprefix}{true}

%% Define colors
\definecolor{titlepagecolor}{cmyk}{1,.60,0,.40}
\definecolor{colorchapternumber}{cmyk}{.0, .43, 1, .02}
\definecolor{colorsectionnumber}{cmyk}{.0, .0, .0, .17}
\colorlet{colorchapterline}{colorchapternumber!45}


\renewcommand*{\dictumwidth}{.5\textwidth}
%% *************************
%% Title Page
%% *************************

\DeclareFixedFont{\titlefont}{T1}{ppl}{b}{it}{0.5in}

\newcommand{\printauthor}{%
    % author needs to be set anyway, as it is required by the classes.
    {\Large \faUser~\theauthor}%
    \ifdefempty{\email}{}{%
      %add line break and eMail if this is set
      {\\\large\faAt~\email}
    }
}

% Author will be set by the org document
% \author{%
%     Author name \\
%     Department name \\
%     \texttt{email2@example.com}
% }

\newcommand\titlepagedecoration{%
\begin{tikzpicture}[remember picture,overlay,shorten >= -10pt]

\coordinate (aux1) at ([yshift=-15pt]current page.north east);
\coordinate (aux2) at ([yshift=-410pt]current page.north east);
\coordinate (aux3) at ([xshift=-4.5cm]current page.north east);
\coordinate (aux4) at ([yshift=-150pt]current page.north east);

\begin{scope}[titlepagecolor!40,line width=12pt,rounded corners=12pt]
\draw
  (aux1) -- coordinate (a)
  ++(225:5) --
  ++(-45:5.1) coordinate (b);
\draw[shorten <= -10pt]
  (aux3) --
  (a) --
  (aux1);
\draw[opacity=0.6,titlepagecolor,shorten <= -10pt]
  (b) --
  ++(225:2.2) --
  ++(-45:2.2);
\end{scope}
\draw[titlepagecolor,line width=8pt,rounded corners=8pt,shorten <= -10pt]
  (aux4) --
  ++(225:0.8) --
  ++(-45:0.8);
\begin{scope}[titlepagecolor!70,line width=6pt,rounded corners=8pt]
\draw[shorten <= -10pt]
  (aux2) --
  ++(225:3) coordinate[pos=0.45] (c) --
  ++(-45:3.1);
\draw
  (aux2) --
  (c) --
  ++(135:2.5) --
  ++(45:2.5) --
  ++(-45:2.5) coordinate[pos=0.3] (d);   
\draw 
  (d) -- +(45:1);
\end{scope}
\end{tikzpicture}%
}

\makeatletter
\renewcommand{\maketitle}{
\pagenumbering{roman}
\thispagestyle{empty}
\noindent
\titlefont\@title\normalfont%
\vspace*{2em}
\ifdefempty\authsec@titlepagedictumtext{%
  % Do nothing if empty
}{%
  \ifdefempty\authsec@titlepagedictumauthor{%
      \dictum[Unknown Author]{\authsec@titlepagedictumtext}%
    }{%
      \dictum[\authsec@titlepagedictumauthor]{\authsec@titlepagedictumtext}%
    }%
}%
\null\vfill
\vspace*{1cm}
\noindent
\hfill
\begin{minipage}{0.45\linewidth}
  \begin{flushright}
    \printauthor%
  \end{flushright}
\end{minipage}
\titlepagedecoration%
\cleardoubleoddpage%
}
\makeatother

\addtotoclist[float]{lol}
\renewcommand*\listoflistings{\listoftoc[{\listoflistingscaption}]{lol}}
\DeclareTOCStyleEntry[
    level=1,
    indent=1.5em,
    numwidth=2.3em
    ]{default}{listing}
\AfterTOCHead[toc]{%
%%  \pagenumbering{arabic}%
  \thispagestyle{empty}%
  \pagestyle{headings}}

\AtBeginEnvironment{abstract}{
  \def\sectfont{\LARGE\selectfont}
}

% **************************************************
% Text Format
% **************************************************
\setstretch{1.2} % value for line spacing, use \setstretch{} or \singlespacing or \onehalfspacing or \doublespacing
\KOMAoptions{DIV=last} % Satzspiegel neu berechnen
%\setlength{\parindent}{0em} % value for paragraph indentation
\tolerance=1414%
\hbadness=1414%
\emergencystretch=1.2em%
\hfuzz=0.3pt%
\vfuzz=24pt%
\clubpenalty=10000% prevent single lines at the beginning of a paragraph (Schusterjungen)
\widowpenalty=10000% prevent single lines at the end of a paragraph (Hurenkinder)
\displaywidowpenalty=10000%
\raggedbottom%

\renewcommand\raggedchapter{\Ifthispageodd{}{\raggedleft}}
%% Redefine Chapter
\RedeclareSectionCommand[%
  beforeskip=1sp,%
  afterindent=false,%
  font=\huge\mdseries%
  ]{chapter}

\renewcommand*{\chapterformat}{%
  \Ifthispageodd{%
     \hfill\smash{\textcolor{colorchapterline}{\rule{2pt}{10cm}}}%
     \rlap{\textcolor{colorchapternumber}{\fontsize{60pt}{60pt}\selectfont\hspace{\marginparsep}\thechapter}}%
   }{%
     \flushleft\smash{\textcolor{colorchapterline}{\rule{2pt}{10cm}}%
     \textcolor{colorchapternumber}{\fontsize{60pt}{60pt}\selectfont\hspace{-\marginparsep-\widthof{\thechapter}}\thechapter}%
     }%
   }
}%

\renewcommand*\chapterlinesformat[3]{%
\Ifstr{#1}{chapter}{%
    \parbox[b]{\dimexpr\textwidth\relax}{\raggedchapter #3}%
    \hfill
    #2
}{%
  \@hangfrom{#2}{#3}% original definition for other levels
}
}

%% 
\makeatletter
\ifauthsec@marginsections%
\KOMAoption{numbers}{noendperiod}
\renewcommand\sectionlinesformat[4]{%
% Ensure that there is at least 1/3 of the page available to print on before setting a section. If this is not the case, start a new page.
% This also helps in correctly choosing the even/odd page section layout in edge cases.
\needspace{.33\textheight}
  \Ifthispageodd{%
    \raggedleft#4\makebox[0pt][l]{\hspace*{\marginparsep}\relax\textcolor{colorsectionnumber}{#3}}%
  }{%
    %% \fontdimen2\font gives the width of the 'n' character in the current font, which is the same as \enskip
    %% That value is removed, as this is auto inserted after the section command (as defined in the sectionformat)
    %% e.g. \renewcommand\sectionformat{\thesection\autodot\enskip}
    \raggedright\makebox[0pt][r]{\textcolor{colorsectionnumber}{#3}\hspace*{\dimexpr\marginparsep-\fontdimen2\font}\relax}#4%
  }%
}%
\fi%
\makeatother

%%%%%%%%%%% Setup index %%%%%%%%%%%%%

%% Generate the index style file
%% When you are modifying the style, activating overwrite mode saves some time
%%\begin{filecontents}[overwrite]{authsec.ist}
\begin{filecontents}{authsec.ist}
headings_flag 1
heading_prefix "{\\large\\sffamily\\bfseries\\textcolor{colorchapternumber} "
heading_suffix "\\nopagebreak\n"
group_skip "}\n\n \\indexspace\n"
item_0 "} \n \\item "
delim_0 " \\dotfill\\hspace*{.5ex}\\hyperpage{"
item_01 "} \n \\subitem "
item_x1 "\n \\subitem "
item_1 "} \n \\subitem "
item_12 "} \n \\subsubitem "
item_2 "} \n \\subsubitem "
item_x2 "\n \\subsubitem "
delim_1 " \\dotfill\\hspace*{.5ex}\\hyperpage{"
delim_2 " \\dotfill\\hspace*{.5ex}\\hyperpage{"
postamble
"}\n
\\end{theindex}"  
\end{filecontents}

%% This disables the indent if a line would be too long to be displayed in the index.
\makeatletter
\def\@idxitem{\par\hangindent 0pt}
\makeatother

%% Create the index
\makeindex[intoc=true,options= -s authsec.ist]

\makeatletter
\ifauthsec@buildglosses%
\makeglossaries
\fi
\makeatother

\endinput
